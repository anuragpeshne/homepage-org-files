#+TITLE: Energy Monitoring using Smart plug and Raspberry Pi
#+DATE: 2021-01-10
#+OPTIONS: toc:t num:nil creator:nil author:t tex:t date:t timestamp:nil
#+INCLUDE: "../../assets/commonHead.org"
#+FILETAGS: :raspberrypi:grafana:
#+AUTHOR: Anurag Peshne

Recently, I became interested in measuring the electricity consumption
of electronic devices at my home and, in particular, my computer. Computer power
supplies are typically rated from 400W to 800W. I wanted to see how much power is
actually needed for day to day computing - writing code, browsing internet, playing
games, running ML jobs. And how does it compare with laptop and other mobile devices.

As a kid, I was once told by an engineer that the bulk of energy is consumed by
the monitor, and the desktop itself consumes very little energy. So if I switch off
the monitor, I can play music, download things overnight without wasting too much
energy. This statement stuck with me over time as my bulky CRT monitor was replaced
with sleek LED monitors and a beefy 250W GPU got added to my desktop. It was time
I measure everything and find out if it still makes sense.

#+CAPTION: Desktop energy consumption on a weekend evening.
#+NAME:   fig:desktop
[[../../assets/energyMonitoring/desktop.png]]

* Hardware
  A quick search revealed that [[https://en.wikipedia.org/wiki/Kill_A_Watt][Kill A Watt]] meters are one of the most popular ways
  of measuring energy consumption. I wanted to log the consumption so that I can
  analyze the trends over time. That's why I passed these meters on. But these meters
  have an inbuilt screen and do not require mobile or network access so they can
  be a great solution if someone is looking for a quick way to see the consumption.
  On the other end of the spectrum, there are some devices that can be plugged directly
  into the circuit panel of the house and they can be used to analyze consumption
  of all appliances in the house. For my goal of measuring energy consumption of
  computer, this was simply an overkill and would not have provided the fine grained
  monitoring I needed (and I'm a little scared of messing with AC power).

  I finally settled on TP-Link Power Strip: [[https://www.kasasmart.com/us/products/smart-plugs/kasa-smart-wi-fi-power-strip-hs300][HS300]]. This /smart/ power strip has
  the usual /smart/ plug features like they can be controlled using a mobile app, but
  it also has energy monitoring. And most importantly there are some awesome projects
  on Github - [[https://github.com/python-kasa/python-kasa][python-kasa]], [[https://github.com/GadgetReactor/pyHS100][pyHS100]] - that have reverse engineered the communication
  protocol and provide a nice interface to talk to them.

* Software
  #+CAPTION: Architecture
  #+NAME:   fig:Architecture
  [[../../assets/energyMonitoring/architecture.svg]]

  Figure 2[fn:1] shows a highlevel picture of how the energy consumption values
  get extracted, stored and visualized.

** Polling HS300
   The project [[https://github.com/python-kasa/python-kasa][python-kasa]] provides a nice interface to control TP-Link devices but there's
   an [[https://github.com/python-kasa/python-kasa/issues/64][issue]] with quering energy monitor of child plugs. That's why I used the project [[https://github.com/GadgetReactor/pyHS100][pyHS100]]
   which seems like an older version of the python-kasa project. I added a cronjob to query
   the powerstrip every 5 minutes and dump the data in a text file, using a simple bash script:
   #+BEGIN_SRC bash
#! /bin/bash

power=$(/home/pi/.local/bin/pyhs100 --strip --host <IP of the powerstrip> emeter | tail -n 1)
timestamp=$(date +%s)

echo -e "$timestamp, $power"
   #+END_SRC
   This creates a bulky line for each sample it records and there is certainly a
   lot of room to compress it. I'm currently sampling it every 5 minutes, so I don't
   mind it, but if you are planning to sample it every minute or every few seconds,
   you might want to trim it down.

** Grafana Datasource
   I'm using Grafana to visualize this data to see trends in usage over time. We
   can dump all of the data into one of the Datasource that is supported by default
   by Grafana but I did not like that extra step for such simple data. So I wrote
   [[https://github.com/anuragpeshne/grafana-kasa-power-strip][my own backend datasource]] that directly serves Grafana, data from the logs we
   collected. This uses the [[https://grafana.com/grafana/plugins/grafana-simple-json-datasource][SimpleJson]] datasource plugin.

* Results
  The results are informative and nothing less than an eye opener. Some devices
  ,like computers, charger, consume varying amount energy and some devices, like
  lamps, consume constant energy. I might write a followup post just about consumption
  of my computer running various workloads and applications. Here are a couple that
  I found interesting:
** Desktop: Coding vs video games
    #+CAPTION: In the first half the computer was used for coding using a simple text editor with light browsing.
    #+NAME:   fig:desktop
    [[../../assets/energyMonitoring/desktop.png]]
** Monitor
    #+CAPTION: Energy consumption of my monitor is constant, until I increased the brightness from 15% to 20%
    #+NAME:   fig:desktop
    [[../../assets/energyMonitoring/monitor.png]]
** Phone charging
    #+CAPTION: IPhone getting charged using the stock charger.
    #+NAME:   fig:desktop
    [[../../assets/energyMonitoring/iphone_charging.png]]


[fn:1] This figure uses Icons made by [[https://www.flaticon.com/authors/dinosoftlabs][DinosoftLabs]], [[https://www.flaticon.com/authors/freepik][Freepik]], [[https://www.flaticon.com/authors/icongeek26][Icongeek26]] from [[https://flaticon.com][www.flaticon.com]]
